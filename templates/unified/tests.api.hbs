import { test, expect } from '@playwright/test';
import { testConfig } from '../config/test-config.js';
import { apiRoutes } from '../routes/api-routes.js';

test.describe('API Routes - Authentication Testing', () => {
  test.beforeEach(async ({ page }) => {
    test.setTimeout(testConfig.timeout);
  });

  // Iterate through all API routes from JSON file
  apiRoutes.forEach(({ url, title, method = 'GET', requiresAuth, expectedStatus, keyElement, timeout }) => {
    test(`${title || `API ${method} ${url}`} should ${requiresAuth ? 'return 401 when not authenticated' : 'be accessible'}`, async ({ request }) => {
      // Set custom timeout if specified for this route
      if (timeout) {
        test.setTimeout(timeout);
      }
      
      console.log(`ğŸ”Œ Testing API route: ${method} ${url}`);
      
      const requestMethod = method.toLowerCase();
      const requestOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'User-Agent': 'PlaywrightRouteTester/2.0.0',
          ...testConfig.defaultHeaders
        }
      };
      
      // Add request body for POST/PUT/PATCH requests
      if (['post', 'put', 'patch'].includes(requestMethod)) {
        requestOptions.data = JSON.stringify({ test: 'data' });
      }
      
      const response = await request[requestMethod](`${testConfig.baseURL}${url}`, requestOptions);
      
      if (requiresAuth) {
        // Expecting authentication error
        const status = response.status();
        expect([401, 403]).toContain(status);
        
        // Verify response indicates authentication issue
        try {
          const responseBody = await response.json().catch(() => ({}));
          const responseText = JSON.stringify(responseBody).toLowerCase();
          
          const isAuthError = responseText.includes('unauthorized') ||
                             responseText.includes('authentication') ||
                             responseText.includes('login') ||
                             responseText.includes('token') ||
                             status === 401 || status === 403;
          
          expect(isAuthError).toBe(true);
        } catch (error) {
          // If we can't parse JSON, just check status code
          expect([401, 403]).toContain(status);
        }
        
        // Check for key response elements if specified (can be null)
        if (keyElement) {
          try {
            const responseBody = await response.text();
            expect(responseBody).toContain(keyElement);
            console.log(`âœ… Key element found in response: ${keyElement}`);
          } catch (error) {
            console.warn(`âš ï¸ Key element not found in API response: ${keyElement}`);
            // Don't fail the test - just log the warning
          }
        }
        
        console.log(`âœ… ${title || `API ${method} ${url}`} properly protected - returned ${status}`);
      } else {
        // Public endpoint - should be accessible
        const status = response.status();
        const expectedCode = expectedStatus || 200;
        
        if (expectedCode === 200) {
          expect(status).toBeLessThan(400);
        } else {
          expect(status).toBe(expectedCode);
        }
        
        // Check for key response elements if specified (can be null)
        if (keyElement) {
          try {
            const responseBody = await response.text();
            expect(responseBody).toContain(keyElement);
            console.log(`âœ… Key element found in response: ${keyElement}`);
          } catch (error) {
            console.warn(`âš ï¸ Key element not found in API response: ${keyElement}`);
            // Don't fail the test - just log the warning
          }
        }
        
        console.log(`âœ… ${title || `API ${method} ${url}`} accessible - returned ${status}`);
      }
      
      {{#ifFramework "express"}}
      // Express-specific API checks
      const contentType = response.headers()['content-type'] || '';
      if (contentType.includes('application/json')) {
        // Verify it's valid JSON
        await expect(async () => {
          await response.json();
        }).not.toThrow();
      }
      {{/ifFramework}}
      
      {{#ifFramework "nextjs"}}
      // Next.js API routes specific checks
      if (url.startsWith('/api/')) {
        const headers = response.headers();
        // Next.js typically sets x-powered-by
        if (headers['x-powered-by']) {
          expect(headers['x-powered-by']).toContain('Next.js');
        }
      }
      {{/ifFramework}}
    });
  });
  
  test.afterAll(async () => {
    const protectedApis = apiRoutes.filter(api => api.requiresAuth).length;
    const publicApis = apiRoutes.filter(api => !api.requiresAuth).length;
    
    console.log(`ğŸ“Š API Security Summary:`);
    console.log(`ğŸ”’ Protected APIs tested: ${protectedApis}`);
    console.log(`ğŸŒ Public APIs tested: ${publicApis}`);
    console.log(`âœ… All APIs behaving as expected`);
  });
});